<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }

      #screenshot {
        border: 3px solid white;
      }

      #box {
        width: 100%;
        height: 5px;
      }

      #screen-button {
        float: left;
      }

      #show-color {
        float: left;
        width: 20px;
        height: 20px;
        margin-top: 2px;
        margin-left: 10px;
        margin-right: 10px;
      }
    </style>
  </head>

  <body>
    <div id="box">
      <button id="screen-button">提取颜色</button>
      <div id="show-color"></div>
      <button id="screen-square">框选范围</button>
    </div>
    <br />
    <script>
      window.addEventListener("mousedown", (e) => {
        const [startX, startY] = [e.clientX, e.clientY];
        const divDom = document.createElement("div");
        divDom.id = "screenshot";
        divDom.width = "1px";
        divDom.height = "1px";
        divDom.style.position = "absolute";
        divDom.style.top = startY + "px";
        divDom.style.left = startX + "px";
        document.body.appendChild(divDom);
        const moveEvent = (e) => {
          const moveX = e.clientX - startX;
          const moveY = e.clientY - startY;
          if (moveX > 0) {
            divDom.style.width = moveX + "px";
          } else {
            divDom.style.width = -moveX + "px";
            divDom.style.left = e.clientX + "px";
          }
          if (moveY > 0) {
            divDom.style.height = moveY + "px";
          } else {
            divDom.style.height = -moveY + "px";
            divDom.style.top = e.clientY + "px";
          }
        };
        window.addEventListener("mousemove", moveEvent);
        window.addEventListener("mouseup", () => {
          window.removeEventListener("mousemove", moveEvent);
        });
      });
    </script>
    <script>
      let canvasWidth, canvasHeight;
      let canvasX, canvasY;
      let selectColor;
      let screenFinished = false;

      const canvasDom = document.createElement("canvas");
      canvasDom.width = 1000;
      canvasDom.height = 800;
      document.body.appendChild(canvasDom);
      const ctx = canvasDom.getContext("2d");
      const img = new Image();
      img.onload = () => {
        ctx.drawImage(img, 0, 0);
      };
      img.src = "https://avatars.githubusercontent.com/u/29791171?v=4";

      document
        .getElementById("screen-button")
        .addEventListener("click", (e) => {
          screenEvent(e);
          const colorInterval = setInterval(() => {
            if (screenFinished) {
              const list = [canvasX, canvasY, canvasWidth, canvasHeight];
              selectColor = computedSquareColor(canvasDom, list);
              document.getElementById("show-color").style.backgroundColor =
                "rgb(" + selectColor + ")";
              clearInterval(colorInterval);
            }
          }, 100);
        });

      document
        .getElementById("screen-square")
        .addEventListener("click", (e) => {
          screenEvent(e);
          const squareInterval = setInterval(() => {
            if (screenFinished) {
              const squareDom = document.createElement("canvas");
              squareDom.width = canvasWidth;
              squareDom.height = canvasHeight;
              squareDom.style.position = "absolute";
              squareDom.style.left = canvasX;
              squareDom.style.top = canvasY;
              document.body.appendChild(squareDom);

              const list = [canvasX, canvasY, canvasWidth, canvasHeight];
              squareAnalyse(canvasDom, squareDom, list);

              clearInterval(squareInterval);
            }
          }, 100);
        });

      function screenEvent(e) {
        screenFinished = false;
        const mousedownEvent = (e) => {
          const [startX, startY] = [e.clientX, e.clientY];
          const divDom = document.createElement("div");
          divDom.id = "screenshot";
          divDom.width = "1px";
          divDom.height = "1px";
          divDom.style.position = "absolute";
          canvasX = startX;
          canvasY = startY;
          divDom.style.top = startY + "px";
          divDom.style.left = startX + "px";
          document.body.appendChild(divDom);
          const moveEvent = (e) => {
            const moveX = e.clientX - startX;
            const moveY = e.clientY - startY;
            if (moveX > 0) {
              divDom.style.width = moveX + "px";
              canvasWidth = moveX;
            } else {
              divDom.style.width = -moveX + "px";
              divDom.style.left = e.clientX + "px";
              canvasWidth = -moveX;
              canvasX = e.clientX;
            }
            if (moveY > 0) {
              divDom.style.height = moveY + "px";
              canvasHeight = moveY;
            } else {
              divDom.style.height = -moveY + "px";
              divDom.style.top = e.clientY + "px";
              canvasHeight = -moveY;
              canvasY = e.clientY;
            }
          };
          window.addEventListener("mousemove", moveEvent);
          window.addEventListener("mouseup", () => {
            window.removeEventListener("mousemove", moveEvent);
            window.removeEventListener("mousedown", mousedownEvent);
            document.body.removeChild(divDom);
            screenFinished = true;
          });
        };
        window.addEventListener("mousedown", mousedownEvent);
      }

      function computedSquareColor(canvasDom, selectedArea) {
        const ctx = canvasDom.getContext("2d");
        //遍历区域内所有像素点，计算rgb值，得到平均rgb值
        let colorR = 0;
        let colorG = 0;
        let colorB = 0;
        for (let i = 0; i < selectedArea[2]; i++) {
          for (let j = 0; j < selectedArea[3]; j++) {
            let mapPointX = selectedArea[0] + i;
            let mapPointY = selectedArea[1] + j;
            let colorArray = ctx.getImageData(mapPointX, mapPointY, 1, 1).data;
            colorR += colorArray[0];
            colorG += colorArray[1];
            colorB += colorArray[2];
          }
        }
        colorR = Math.ceil(colorR / (selectedArea[2] * selectedArea[3]));
        colorG = Math.ceil(colorG / (selectedArea[2] * selectedArea[3]));
        colorB = Math.ceil(colorB / (selectedArea[2] * selectedArea[3]));
        return [colorR, colorG, colorB];
      }

      async function squareAnalyse(canvasDom, squareDom, selectedArea) {
        let alw = 15;
        let stride = 1;

        //canvasDom是原图，squareDom是用来绘制的
        let squareCtx = squareDom.getContext("2d");
        let ctx = canvasDom.getContext("2d");

        //填充背景
        squareCtx.fillStyle = "rgba(255,255,255,0.5)";
        squareCtx.fillRect(0, 0, canvasWidth, canvasHeight);

        let squareImgData = squareCtx.getImageData(
          0,
          0,
          canvasWidth,
          canvasHeight
        );
        await areaTotalAnalyse();
        squareCtx.putImageData(squareImgData, 0, 0);

        //对整个区域进行整体的识别，会以面的形式标记整个区域
        async function areaTotalAnalyse() {
          for (let i = 0; i < selectedArea[2]; i += stride) {
            for (let j = 0; j < selectedArea[3]; j += stride) {
              let mapPointX = selectedArea[0] + i;
              let mapPointY = selectedArea[1] + j;
              let rgbaArray = ctx.getImageData(mapPointX, mapPointY, 1, 1).data;
              let rgbArray = [rgbaArray[0], rgbaArray[1], rgbaArray[2]];
              if ((await differenceRGB(selectColor, rgbArray)) <= alw) {
                squareImgData = await editCanvas(
                  i,
                  j,
                  canvasWidth,
                  squareImgData
                );
              }
            }
            console.log("循环中");
          }
          return squareImgData;
        }

        //改变canvas像素点颜色
        async function editCanvas(i, j, canvasWidth, squareImgData) {
          squareImgData.data[4 * j * canvasWidth + 4 * i] = 0;
          squareImgData.data[4 * j * canvasWidth + 4 * i + 1] = 0;
          squareImgData.data[4 * j * canvasWidth + 4 * i + 2] = 0;
          squareImgData.data[4 * j * canvasWidth + 4 * i + 3] = 255;
          return squareImgData;
        }
      }
    </script>
  </body>
</html>
